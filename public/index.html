<!doctype html>
<html>
  <head>
    <title>Chat Room</title>
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <div id="nickWrap">
      <p>Username:</p>
      <!-- <p id="nickError"></p>-->
      <form id="setNick">
        <input id="nickname" /><button>Submit</button>
      </form>
    </div>



        <div class="topNav">
          <ul class="channels">
            <li><a href="#Main">##Main</a></li>
            <li><a href="#FIU">##FIU</a></li>
            <li><a href="#WebAppDevelopment">##WebAppDevelopment</a></li>
          </ul>
        </div>


        <main class="chat">
          <section class="chat-panel chat-panel__users">
            <div class="chat-list users">
            </div>
            <div class="chat-ui channel-search">
              <select id="channels">
              </select>
            </div>
          </section>
          <section class="chat-panel chat-panel__messages">
            <div class="chat-list messages">
            </div>
            <form id="messageForm">
              <div class="chat-ui message-box">
                <input class="messageInput" type="text" placeholder="Type your message here">
                <button>Send</button>
              </div>
          </form>
          </section>
        </main>

        <!--
          <div id="chatWrap">
            <div id="chat"></div>
            <ul id="messages"></ul>
            <form id="send-message" action="">
              <input id="m" autocomplete="off" /><button>Send</button>
            </form>
          </div>
          <div id="users"></div>
        -->

<!-- BODY ENDS -->

<!-- loading socket io to client
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
    </script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
    var socket = io();
    var $nickFrom = $('#setNick');
    var $nickBox = $('#nickname');
    var $users = $('.users');
    var $messageForm = $('#messageForm');
    var $messageBox = $('.messageInput');
    var $chat = $('#chat');

    $(function(){
      $('#nickWrap').show();
      $('.topNav').hide();
      $('.chat').hide();

    })




 // FINISH  SOON //

    $nickFrom.submit(function(e){
      e.preventDefault();
      socket.emit('new user', $nickBox.val(), function(callback){
        if(callback){
          $('#nickWrap').hide();
          $('.topNav').show();
          $('.chat').show();
        }
          else{
            $('#nickWrap').hide();
            $('.topNav').show();
            $('.chat').show();
          }
      });
      $nickBox.val('');

    }





// UUID handling
/*
    // Server will call connection function once io() is called which will force
    // local browser to create UUID. This will then be used by the server to uniquely
    // identify the socket by UUID.

    // UUID can be used to determine Admin and identify specific people

    socket.on('connection', function(){
      //
      if (!(uuid = localStorage.getItem('uuid'))) {
        var randomlyGeneratedUID = Math.random().toString(36).substring(3, 16) + +new Date;
        // UUID will be stored locally
        localStorage.setItem('uuid', randomlyGeneratedUID);
    })
    // Will emit UUID to
    socket.emit('registerUUID', uuid + "," + nickNameRegistered);

*/

  );


  // FINISH SOON //

        // Handles clearing the messages
        socket.on('clear', function(){
          $('messages').innerHTML = "";
        });


        // Handles command errors when user inputs erroneous command
        // (keeps server from crashing)
        socket.on('commandError', function(){
          var errorMessage = document.createElement("article");
          errorMessage.innerHTML = '<b>Invalid Command!</b>';
          $('.messages').append(errorMessage);
        })

        // Handles user joining a certain channel
        // socket.on('joinChannel', function(channelLog){

        // });

        // Handles command errors when user inputs erroneous channel command
        socket.on('channelError', function(cause){
          var errorMessage = document.createElement("article");
          if(cause == "invalidChannel")
          {
            errorMessage.innerHTML = '<b>--Invalid Channel Selection!--</b>';
          }
          else if (cause =='forbiddenChannel')
          {
            errorMessage.innerHTML = '<b>--Forbidden Channel Selection!--</b>';
          }
          $('.messages').append(errorMessage);
        })


        // // Updates the channel list for users
        // socket.on('updateChannelList', function(channelList){
        //   // START CHANNEL UPDATE
        //
        //   console.log(channelList);
        //   for(var line in channelList)
        //   {
        //     var channel = document.createElement("option");
        //     channel.innerHTML = line;
        //     $('#channels').append(channel);
        //   }
        //
        //   // END CHANNEL UPDATE
        // });

        // Updates the channel list for users
        socket.on('updateChannelList', function(channelList){
          // START CHANNEL UPDATE
          console.log(channelList);
          for(var line in channelList)
          {
            var channel = document.createElement("option");
            channel.innerHTML = line;
            $('#channels').append(channel);
          }
          // END CHANNEL UPDATE
        });


        // Updates chatlog
        socket.on('updateChatLog', function(chatLog){
          socket.emit('clear');

          var splitMessage = chatLog.split("\n");
          //console.log(splitMessage);

          for(var line in splitMessage)
          {
            //console.log(splitMessage[line]);
            var txtWritten = document.createElement("article");
            txtWritten.innerHTML = splitMessage[line];
            $('.messages').append(txtWritten);
          }

        });


        socket.on('usernames', function(data){
          var html = '';
          for (i=0; i < data.length; i++){
            html += data[i] + '<br/>'
          }
          $users.html(html);
        });


    $messageForm.submit(function(e){
      e.preventDefault();
      socket.emit('send message', $messageBox.val());
      $messageBox.val('');
      //return false;
      });

      socket.on('new message', function(data){
        console.log(data);
        //$chat.append('<b>' + data.nick + ': </b>' + data.msg + "<br/>");
        var txtWritten = document.createElement("article");
        txtWritten.innerHTML = '<b>' + data.nick + ': </b>' + data.msg;
        $('.messages').append(txtWritten);
      });


      </script>
  </body>
</html>
